import { HashtagOptimizationService } from '../HashtagOptimizationService';
import { Platform } from '../../types/platform';

describe('HashtagOptimizationService', () => {
  describe('validateHashtags', () => {
    it('should validate properly formatted hashtags', () => {
      const hashtags = ['#tech', '#innovation', '#AI'];
      const result = HashtagOptimizationService.validateHashtags(hashtags, Platform.FACEBOOK);
      
      expect(result.isValid).toBe(true);
      expect(result.errors).toHaveLength(0);
    });

    it('should reject hashtags without # symbol', () => {
      const hashtags = ['tech', '#innovation'];
      const result = HashtagOptimizationService.validateHashtags(hashtags, Platform.FACEBOOK);
      
      expect(result.isValid).toBe(false);
      expect(result.errors).toContain('Hashtag "tech" must start with #');
    });

    it('should reject hashtags that are too short', () => {
      const hashtags = ['#a'];
      const result = HashtagOptimizationService.validateHashtags(hashtags, Platform.FACEBOOK);
      
      expect(result.isValid).toBe(false);
      expect(result.errors).toContain('Hashtag "#a" is too short');
    });

    it('should reject hashtags that are too long', () => {
      const longHashtag = '#' + 'a'.repeat(100);
      const hashtags = [longHashtag];
      const result = HashtagOptimizationService.validateHashtags(hashtags, Platform.FACEBOOK);
      
      expect(result.isValid).toBe(false);
      expect(result.errors).toContain(`Hashtag "${longHashtag}" is too long (max 100 characters)`);
    });

    it('should reject hashtags with invalid characters', () => {
      const hashtags = ['#tech-innovation', '#hello world'];
      const result = HashtagOptimizationService.validateHashtags(hashtags, Platform.FACEBOOK);
      
      expect(result.isValid).toBe(false);
      expect(result.errors).toContain('Hashtag "#tech-innovation" contains invalid characters');
      expect(result.errors).toContain('Hashtag "#hello world" contains invalid characters');
    });

    it('should enforce platform-specific hashtag limits', () => {
      const manyHashtags = Array(35).fill('#test'); // Exceeds Facebook limit of 30
      const result = HashtagOptimizationService.validateHashtags(manyHashtags, Platform.FACEBOOK);
      
      expect(result.isValid).toBe(false);
      expect(result.errors).toContain('Too many hashtags (35). Maximum for facebook: 30');
    });

    it('should warn about suboptimal hashtag counts', () => {
      // Too few for Instagram
      const fewHashtags = ['#tech'];
      const instagramResult = HashtagOptimizationService.validateHashtags(fewHashtags, Platform.INSTAGRAM);
      expect(instagramResult.warnings).toContain('Consider adding more hashtags. Optimal range for instagram: 5-10');

      // Too many for Facebook
      const manyHashtags = ['#tech', '#innovation', '#AI', '#business', '#startup'];
      const facebookResult = HashtagOptimizationService.validateHashtags(manyHashtags, Platform.FACEBOOK);
      expect(facebookResult.warnings).toContain('Consider reducing hashtags. Optimal range for facebook: 1-3');
    });

    it('should generate suggestions when content context is provided', () => {
      const hashtags = ['#tech'];
      const content = 'This is about technology and innovation in business';
      const result = HashtagOptimizationService.validateHashtags(hashtags, Platform.INSTAGRAM, content);
      
      expect(result.suggestions.length).toBeGreaterThan(0);
      expect(result.suggestions[0]).toHaveProperty('hashtag');
      expect(result.suggestions[0]).toHaveProperty('popularity');
      expect(result.suggestions[0]).toHaveProperty('category');
      expect(result.suggestions[0]).toHaveProperty('reason');
    });
  });

  describe('analyzeHashtags', () => {
    it('should analyze hashtags for Facebook', () => {
      const hashtags = ['#tech', '#innovation'];
      const result = HashtagOptimizationService.analyzeHashtags(hashtags, Platform.FACEBOOK);
      
      expect(result.isOptimal).toBe(true);
      expect(result.count).toBe(2);
      expect(result.maxRecommended).toBe(3);
      expect(result.warnings).toBeInstanceOf(Array);
      expect(result.improvements).toBeInstanceOf(Array);
    });

    it('should analyze hashtags for Instagram', () => {
      const hashtags = ['#tech', '#innovation', '#AI', '#business', '#startup', '#entrepreneur', '#digital'];
      const result = HashtagOptimizationService.analyzeHashtags(hashtags, Platform.INSTAGRAM);
      
      expect(result.isOptimal).toBe(true);
      expect(result.count).toBe(7);
      expect(result.maxRecommended).toBe(10);
    });

    it('should provide platform-specific improvements', () => {
      const manyHashtags = Array(5).fill('#test');
      const facebookResult = HashtagOptimizationService.analyzeHashtags(manyHashtags, Platform.FACEBOOK);
      expect(facebookResult.improvements).toContain('Facebook posts perform better with 1-3 hashtags');

      const fewHashtags = ['#tech'];
      const instagramResult = HashtagOptimizationService.analyzeHashtags(fewHashtags, Platform.INSTAGRAM);
      expect(instagramResult.improvements).toContain('Instagram posts can benefit from 5-10 relevant hashtags');

      const xHashtags = ['#tech', '#innovation', '#AI'];
      const xResult = HashtagOptimizationService.analyzeHashtags(xHashtags, Platform.X);
      expect(xResult.improvements).toContain('X posts work best with 1-2 focused hashtags');
    });
  });

  describe('suggestHashtagsForContent', () => {
    it('should suggest hashtags for Facebook content', () => {
      const content = 'This is about technology and innovation in business';
      const suggestions = HashtagOptimizationService.suggestHashtagsForContent(content, Platform.FACEBOOK);
      
      expect(suggestions).toHaveLength(3); // Facebook optimal max
      expect(suggestions[0]).toHaveProperty('hashtag');
      expect(suggestions[0]).toHaveProperty('popularity');
      expect(suggestions[0]).toHaveProperty('category');
      expect(suggestions[0]).toHaveProperty('reason');
    });

    it('should suggest hashtags for Instagram content', () => {
      const content = 'This is about technology and innovation in business';
      const suggestions = HashtagOptimizationService.suggestHashtagsForContent(content, Platform.INSTAGRAM);
      
      expect(suggestions).toHaveLength(10); // Instagram optimal max
      expect(suggestions.some(s => s.category === 'niche')).toBe(true);
      expect(suggestions.some(s => s.category === 'popular')).toBe(true);
    });

    it('should suggest hashtags for Pinterest content', () => {
      const content = 'This is about design and creative inspiration';
      const suggestions = HashtagOptimizationService.suggestHashtagsForContent(content, Platform.PINTEREST);
      
      expect(suggestions).toHaveLength(5); // Pinterest optimal max
      expect(suggestions.some(s => s.category === 'broad')).toBe(true);
    });

    it('should suggest hashtags for X content', () => {
      const content = 'This is about technology trends';
      const suggestions = HashtagOptimizationService.suggestHashtagsForContent(content, Platform.X);
      
      expect(suggestions).toHaveLength(2); // X optimal max
      expect(suggestions.some(s => s.category === 'targeted' || s.category === 'trending')).toBe(true);
    });
  });

  describe('optimizeHashtagsForPlatform', () => {
    it('should remove duplicate hashtags', () => {
      const hashtags = ['#tech', '#tech', '#innovation', '#innovation'];
      const result = HashtagOptimizationService.optimizeHashtagsForPlatform(hashtags, Platform.FACEBOOK);
      
      expect(result.optimized).toEqual(['#tech', '#innovation']);
      expect(result.changes).toContain('Removed 2 duplicate hashtags');
    });

    it('should trim to optimal count', () => {
      const manyHashtags = Array(10).fill(0).map((_, i) => `#hashtag${i}`);
      const result = HashtagOptimizationService.optimizeHashtagsForPlatform(manyHashtags, Platform.FACEBOOK);
      
      expect(result.optimized).toHaveLength(3); // Facebook optimal max
      expect(result.changes).toContain('Reduced to 3 hashtags for optimal facebook performance');
    });

    it('should add suggestions when below minimum', () => {
      const fewHashtags = ['#tech'];
      const content = 'This is about technology and innovation';
      const result = HashtagOptimizationService.optimizeHashtagsForPlatform(fewHashtags, Platform.INSTAGRAM, content);
      
      expect(result.optimized.length).toBeGreaterThan(1);
      expect(result.changes.some(c => c.includes('Added') && c.includes('suggested hashtags'))).toBe(true);
    });

    it('should handle empty hashtag arrays', () => {
      const result = HashtagOptimizationService.optimizeHashtagsForPlatform([], Platform.FACEBOOK);
      
      expect(result.optimized).toEqual([]);
      expect(result.changes).toHaveLength(0);
    });
  });

  describe('keyword extraction', () => {
    it('should extract relevant keywords from content', () => {
      const content = 'This is about technology innovation and artificial intelligence in business';
      // Access private method for testing
      const keywords = (HashtagOptimizationService as any).extractKeywords(content);
      
      expect(keywords).toContain('technology');
      expect(keywords).toContain('innovation');
      expect(keywords).toContain('artificial');
      expect(keywords).toContain('intelligence');
      expect(keywords).toContain('business');
      expect(keywords).not.toContain('this'); // Stop word
      expect(keywords).not.toContain('and'); // Stop word
    });

    it('should filter out short words and stop words', () => {
      const content = 'The cat is on the mat and it is big';
      const keywords = (HashtagOptimizationService as any).extractKeywords(content);
      
      expect(keywords).not.toContain('the');
      expect(keywords).not.toContain('is');
      expect(keywords).not.toContain('on');
      expect(keywords).not.toContain('and');
      expect(keywords).not.toContain('it');
      expect(keywords).not.toContain('cat'); // Too short
      expect(keywords).not.toContain('mat'); // Too short
      expect(keywords).not.toContain('big'); // Too short
    });
  });

  describe('category hashtag matching', () => {
    it('should match content to appropriate hashtag categories', () => {
      const businessContent = 'This is about business and entrepreneurship';
      const categoryHashtags = (HashtagOptimizationService as any).getCategoryHashtags(businessContent);
      
      expect(categoryHashtags.some((tag: string) => tag.includes('business') || tag.includes('entrepreneur'))).toBe(true);

      const techContent = 'This is about technology and innovation';
      const techCategoryHashtags = (HashtagOptimizationService as any).getCategoryHashtags(techContent);
      
      expect(techCategoryHashtags.some((tag: string) => tag.includes('tech') || tag.includes('innovation'))).toBe(true);
    });
  });

  describe('platform-specific hashtag generation', () => {
    it('should generate appropriate hashtags for each platform', () => {
      const keywords = ['technology', 'innovation'];
      const categoryHashtags = ['#tech', '#business'];

      const facebookHashtags = (HashtagOptimizationService as any).getFacebookHashtags(keywords, categoryHashtags);
      expect(facebookHashtags.length).toBeLessThanOrEqual(3);

      const instagramHashtags = (HashtagOptimizationService as any).getInstagramHashtags(keywords, categoryHashtags);
      expect(instagramHashtags.length).toBeLessThanOrEqual(10);
      expect(instagramHashtags.some((h: any) => h.category === 'niche')).toBe(true);
      expect(instagramHashtags.some((h: any) => h.category === 'popular')).toBe(true);

      const pinterestHashtags = (HashtagOptimizationService as any).getPinterestHashtags(keywords, categoryHashtags);
      expect(pinterestHashtags.length).toBeLessThanOrEqual(5);
      expect(pinterestHashtags.some((h: any) => h.category === 'broad')).toBe(true);

      const xHashtags = (HashtagOptimizationService as any).getXHashtags(keywords, categoryHashtags);
      expect(xHashtags.length).toBeLessThanOrEqual(2);
    });
  });
});